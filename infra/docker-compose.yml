version: '3.8'

services:
  # ============================================
  # DATABASES
  # ============================================
  mongodb:
    image: mongo:5.0
    container_name: aapda-mongodb
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    environment:
      # Use lowercase database name consistently
      - MONGO_INITDB_DATABASE=aapdasetu
    networks:
      - aapda-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: aapda-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - aapda-network
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # BACKEND SERVICES
  # ============================================
  api-gateway:
    build:
      context: ../backend/api-gateway
      dockerfile: ../../infra/dockerfiles/api-gateway.Dockerfile
    container_name: aapda-api-gateway
    ports:
      - "5000:5000"
    environment:
      - NODE_ENV=development
      - PORT=5000
      - MONGODB_URI=mongodb://mongodb:27017/aapdasetu
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - JWT_SECRET=${JWT_SECRET:-g+hcFkUqpJYGW76BwhkncMro/59Q+Pfh78J6o3cQYpU=}
      - ML_CPU_URL=http://ml-cpu:8000
      - ML_GPU_URL=http://ml-gpu:8001
      - ALLOWED_ORIGINS=http://localhost:3000,http://admin-dashboard:3000
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - aapda-network
    volumes:
      - ../backend/api-gateway:/app
      - /app/node_modules

  # ============================================
  # ML SERVICES
  # ============================================
  ml-cpu:
    build:
      context: ../backend/ml-service-cpu
      dockerfile: ../../infra/dockerfiles/ml-cpu.Dockerfile
    container_name: aapda-ml-cpu
    ports:
      - "8000:8000"
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - aapda-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3

  ml-gpu:
    build:
      context: ../backend/ml-service-gpu
      dockerfile: ../../infra/dockerfiles/ml-gpu.Dockerfile
    container_name: aapda-ml-gpu
    ports:
      - "8001:8001"
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - aapda-network
    # Uncomment for GPU support:
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]

  ai-service:
    build:
      context: ../backend/ai-service
      dockerfile: ../../infra/dockerfiles/ai-service.Dockerfile
    container_name: aapda-ai-service
    ports:
      - "8002:8000"
    environment:
      - FLASK_ENV=development
    networks:
      - aapda-network

  # ============================================
  # FRONTEND
  # ============================================
  admin-dashboard:
    build:
      context: ../admin-dashboard
      dockerfile: ../infra/dockerfiles/admin-dashboard.Dockerfile
    container_name: aapda-admin-dashboard
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_BASE_URL=http://localhost:5000
      - NEXT_PUBLIC_MAP_STYLE_URL=https://demotiles.maplibre.org/style.json
    depends_on:
      - api-gateway
    networks:
      - aapda-network
    volumes:
      - ../admin-dashboard:/app
      - /app/node_modules
      - /app/.next

  # ============================================
  # REVERSE PROXY (Optional)
  # ============================================
  nginx:
    image: nginx:alpine
    container_name: aapda-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - api-gateway
      - admin-dashboard
    networks:
      - aapda-network
    profiles:
      - production

# ============================================
# NETWORKS & VOLUMES
# ============================================
networks:
  aapda-network:
    driver: bridge

volumes:
  mongodb_data:
  redis_data:
